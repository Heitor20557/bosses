<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Floral Fury: Island Extreme</title>
    <style>
        body { margin: 0; background: #0a0a0a; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; font-family: 'Arial Black', sans-serif; }
        canvas { background: #1e272e; border: 6px solid #333; box-shadow: 0 0 100px #000; cursor: crosshair; }
        #hud { position: absolute; top: 20px; left: 20px; color: #ff3e3e; font-size: 24px; text-shadow: 2px 2px #000; display: none; pointer-events: none; z-index: 10; }
    </style>
</head>
<body>

<div id="hud">HP: <span id="hp-val">3</span> | BOSS: <span id="boss-lvl">---</span></div>
<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = 800; canvas.height = 450;

let gameState = 'MENU';
let bossesUnlocked = 1; // 1: Flower, 2: Umbrella, 3: Stone, 4: Void
let screenShake = 0;
const keys = {};

// Sistema de Mouse com ProgressÃ£o
window.addEventListener('mousedown', e => {
    if (gameState === 'HUB') {
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left;
        const my = e.clientY - rect.top;
        
        if (mx > 100 && mx < 200 && my > 200 && my < 300) startBoss(1);
        if (mx > 350 && mx < 450 && my > 100 && my < 200 && bossesUnlocked >= 2) startBoss(2);
        if (mx > 600 && mx < 700 && my > 200 && my < 300 && bossesUnlocked >= 3) startBoss(3);
        if (mx > 350 && mx < 450 && my > 250 && my < 350 && bossesUnlocked >= 4) startBoss(4);
    }
});

window.addEventListener('keydown', e => {
    keys[e.code] = true;
    if (gameState === 'MENU' && e.code === 'Enter') gameState = 'HUB';
    else if ((gameState === 'GAMEOVER' || gameState === 'WIN') && e.code === 'Enter') gameState = 'HUB';
});
window.addEventListener('keyup', e => keys[e.code] = false);

let player, boss, umbrellaBoss, stoneBoss, voidBoss, pBullets, bBullets, platforms;

function startBoss(id) {
    player = { x: 100, y: 300, w: 35, h: 50, vx: 0, vy: 0, speed: 5, jump: -14, grounded: false, hp: 3, shootTimer: 0, invul: 0, dashTimer: 0, isDashing: false, gravity: 0.7 };
    pBullets = []; bBullets = [];
    platforms = [{x: 80, y: 310, w: 100, h: 15}, {x: 230, y: 230, w: 100, h: 15}, {x: 380, y: 310, w: 100, h: 15}];
    
    boss = {active: false}; umbrellaBoss = {active: false}; stoneBoss = {active: false}; voidBoss = {active: false};

    if (id === 1) {
        boss = { x: 550, y: 70, w: 180, h: 160, hp: 100, phase: 1, attackTimer: 0, active: true, isDying: false };
        document.getElementById('boss-lvl').innerText = "FLOR FASE 1";
    } else if (id === 2) {
        umbrellaBoss = { x: 400, y: 50, w: 160, h: 120, hp: 150, phase: 1, attackTimer: 0, active: true, vx: 3, vy: 2, isDying: false, rotation: 0 };
        document.getElementById('boss-lvl').innerText = "UMBRELLA FASE 1";
    } else if (id === 3) {
        stoneBoss = { x: 550, y: 150, w: 150, h: 220, hp: 250, phase: 1, attackTimer: 0, active: true, isDying: false, vx: 4 };
        document.getElementById('boss-lvl').innerText = "STONE FASE 1";
    } else if (id === 4) {
        voidBoss = { x: 325, y: 50, w: 150, h: 150, hp: 400, phase: 1, attackTimer: 0, active: true, isDying: false };
        document.getElementById('boss-lvl').innerText = "VOID FASE 1";
    }
    
    gameState = 'PLAYING';
    document.getElementById('hud').style.display = 'block';
    updateHUD();
}

function updateHUD() { document.getElementById('hp-val').innerText = player.hp; }

function checkRectCollision(a, b) {
    let bw = b.w || b.size || 10; let bh = b.h || b.size || 10;
    return a.x < b.x + bw && a.x + (a.w || 35) > b.x && a.y < b.y + bh && a.y + (a.h || 50) > b.y;
}

function update() {
    if (gameState === 'HUB') {
        if (keys['ArrowLeft']) player.x -= 4; if (keys['ArrowRight']) player.x += 4;
        if (keys['ArrowUp']) player.y -= 4; if (keys['ArrowDown']) player.y += 4;
        return;
    }
    if (gameState !== 'PLAYING') return;

    // --- PLAYER (LÃ“GICA ORIGINAL PRESERVADA) ---
    if (keys['KeyC'] && player.dashTimer <= 0) { player.isDashing = true; player.dashTimer = 40; player.invul = 15; }
    if (player.isDashing) { player.vx = 15; if (player.dashTimer < 25) player.isDashing = false; } 
    else { player.vx = keys['ArrowLeft'] ? -player.speed : (keys['ArrowRight'] ? player.speed : 0); }
    if (player.dashTimer > 0) player.dashTimer--;
    if ((keys['Space'] || keys['KeyZ']) && player.grounded) { player.vy = player.jump; player.grounded = false; }
    
    player.vy += player.gravity; player.x += player.vx; player.y += player.vy;

    if (player.y + player.h > canvas.height - 40) { player.y = canvas.height - 40 - player.h; player.vy = 0; player.grounded = true; }
    if (player.y < 0) { player.y = 0; player.vy = 0; } // Trava no teto para o boss 4
    
    platforms.forEach(p => { if (player.vy > 0 && checkRectCollision(player, p) && player.y + player.h < p.y + 15) { player.y = p.y - player.h; player.vy = 0; player.grounded = true; } });

    if (keys['KeyX'] && player.shootTimer <= 0) { pBullets.push({x: player.x + player.w, y: player.y + 15, size: 8}); player.shootTimer = 10; }
    if (player.shootTimer > 0) player.shootTimer--;

    pBullets.forEach((b, i) => {
        b.x += 12;
        if (boss.active && checkRectCollision(b, boss)) { boss.hp -= 1.2; pBullets.splice(i, 1); }
        else if (umbrellaBoss.active && checkRectCollision(b, umbrellaBoss)) { umbrellaBoss.hp -= 1.5; pBullets.splice(i, 1); }
        else if (stoneBoss.active && checkRectCollision(b, stoneBoss)) { stoneBoss.hp -= 1.5; pBullets.splice(i, 1); }
        else if (voidBoss.active && checkRectCollision(b, voidBoss)) { voidBoss.hp -= 2; pBullets.splice(i, 1); }
    });

    // --- BOSS 1: FLOR ---
    if (boss.active) {
        boss.attackTimer++;
        if (boss.hp < 66 && boss.phase === 1) { boss.phase = 2; document.getElementById('boss-lvl').innerText = "FLOR FASE 2"; }
        if (boss.hp < 33 && boss.phase === 2) { boss.phase = 3; document.getElementById('boss-lvl').innerText = "FLOR FASE FINAL"; }
        if (boss.attackTimer % 70 === 0) bBullets.push({x: boss.x, y: 150, vx: -7, vy: (Math.random()-0.5)*4, size: 20, color: '#ffa502'});
        if (boss.hp <= 0) { bossesUnlocked = Math.max(bossesUnlocked, 2); gameState = 'WIN'; }
    }

    // --- BOSS 2: UMBRELLA ---
    else if (umbrellaBoss.active) {
        umbrellaBoss.attackTimer++;
        if (umbrellaBoss.hp < 100 && umbrellaBoss.phase === 1) { umbrellaBoss.phase = 2; document.getElementById('boss-lvl').innerText = "UMBRELLA FASE 2"; }
        if (umbrellaBoss.hp < 50 && umbrellaBoss.phase === 2) { umbrellaBoss.phase = 3; document.getElementById('boss-lvl').innerText = "UMBRELLA FASE FINAL"; }
        umbrellaBoss.x += umbrellaBoss.vx; if (umbrellaBoss.x > 600 || umbrellaBoss.x < 50) umbrellaBoss.vx *= -1;
        if (umbrellaBoss.attackTimer % 40 === 0) bBullets.push({x: umbrellaBoss.x + 80, y: umbrellaBoss.y + 100, vx: 0, vy: 6, size: 12, color: '#3498db'});
        if (umbrellaBoss.hp <= 0) { bossesUnlocked = Math.max(bossesUnlocked, 3); gameState = 'WIN'; }
    }

    // --- BOSS 3: STONE (MUITO MAIS DIFÃCIL) ---
    else if (stoneBoss.active) {
        stoneBoss.attackTimer++;
        stoneBoss.x += stoneBoss.vx;
        if (stoneBoss.x > 600 || stoneBoss.x < 100) stoneBoss.vx *= -1;
        
        if (stoneBoss.hp < 170 && stoneBoss.phase === 1) { stoneBoss.phase = 2; document.getElementById('boss-lvl').innerText = "STONE FASE 2"; }
        if (stoneBoss.hp < 80 && stoneBoss.phase === 2) { stoneBoss.phase = 3; document.getElementById('boss-lvl').innerText = "STONE FASE FINAL"; }
        
        if (stoneBoss.attackTimer % 100 === 0) { screenShake = 15; bBullets.push({x: 800, y: 380, vx: -10, vy: 0, size: 50, color: '#7f8c8d'}); }
        if (stoneBoss.phase >= 2 && stoneBoss.attackTimer % 30 === 0) bBullets.push({x: Math.random()*800, y: -50, vx: 0, vy: 8, size: 25, color: '#2c3e50'});
        if (stoneBoss.hp <= 0) { bossesUnlocked = Math.max(bossesUnlocked, 4); gameState = 'WIN'; }
    }

    // --- BOSS 4: VOID (QUASE IMPOSSÃVEL) ---
    else if (voidBoss.active) {
        voidBoss.attackTimer++;
        if (voidBoss.hp < 300 && voidBoss.phase === 1) { voidBoss.phase = 2; document.getElementById('boss-lvl').innerText = "VOID FASE 2"; }
        if (voidBoss.hp < 150 && voidBoss.phase === 2) { voidBoss.phase = 3; document.getElementById('boss-lvl').innerText = "VOID FASE FINAL"; }

        // DinÃ¢mica: InversÃ£o de Gravidade
        if (voidBoss.phase >= 2 && voidBoss.attackTimer % 200 === 0) player.gravity *= -1;
        
        // Ataques Bullet Hell
        if (voidBoss.attackTimer % 40 === 0) {
            for(let i=0; i<8; i++) {
                let a = (Math.PI*2/8)*i + (voidBoss.attackTimer*0.05);
                bBullets.push({x: voidBoss.x+75, y: voidBoss.y+75, vx: Math.cos(a)*6, vy: Math.sin(a)*6, size: 15, color: '#a29bfe'});
            }
        }
        if (voidBoss.hp <= 0) gameState = 'WIN';
    }

    bBullets.forEach((b, i) => {
        b.x += b.vx || 0; b.y += b.vy || 0;
        if (checkRectCollision(b, player) && player.invul <= 0) { player.hp--; player.invul = 60; updateHUD(); bBullets.splice(i, 1); }
    });

    if (player.invul > 0) player.invul--;
    if (player.hp <= 0) gameState = 'GAMEOVER';
    if (screenShake > 0) screenShake--;
}

function draw() {
    ctx.save();
    if (screenShake > 0) ctx.translate(Math.random()*screenShake - screenShake/2, Math.random()*screenShake - screenShake/2);
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (gameState === 'MENU') {
        ctx.fillStyle = '#1e272e'; ctx.fillRect(0,0,800,450);
        ctx.fillStyle = 'white'; ctx.textAlign = 'center'; ctx.font = '50px Arial Black';
        ctx.fillText('ISLAND OF FURY', 400, 200);
        ctx.font = '20px Arial'; ctx.fillText('PRESS ENTER TO START', 400, 260);
    } 
    else if (gameState === 'HUB') {
        // Design do Mapa
        let grd = ctx.createRadialGradient(400,225,50,400,225,400);
        grd.addColorStop(0, "#2ecc71"); grd.addColorStop(1, "#27ae60");
        ctx.fillStyle = grd; ctx.fillRect(0,0,800,450);
        
        drawIcon(150, 250, '#e74c3c', 'FLOWER', true);
        drawIcon(400, 150, '#3498db', 'UMBRELLA', bossesUnlocked >= 2);
        drawIcon(650, 250, '#95a5a6', 'STONE', bossesUnlocked >= 3);
        drawIcon(400, 300, '#8e44ad', 'VOID', bossesUnlocked >= 4);

        ctx.fillStyle = 'red'; ctx.shadowBlur = 10; ctx.shadowColor = "black";
        ctx.fillRect(player.x, player.y, 25, 25);
    }
    else if (gameState === 'PLAYING') {
        // Arena Design
        let arenaGrd = ctx.createLinearGradient(0,0,0,450);
        arenaGrd.addColorStop(0, "#2c3e50"); arenaGrd.addColorStop(1, "#000000");
        ctx.fillStyle = arenaGrd; ctx.fillRect(0,0,800,450);
        
        ctx.fillStyle = '#10ac84'; ctx.fillRect(0, 410, 800, 40);
        ctx.fillStyle = '#ff6b81'; platforms.forEach(p => ctx.fillRect(p.x, p.y, p.w, p.h));

        if (boss.active) {
            drawBossBody(boss.x + 90, 150, 80, '#ffa502');
            ctx.fillStyle = '#2d5a27'; ctx.fillRect(boss.x+80, 230, 20, 180);
        }
        if (umbrellaBoss.active) {
            ctx.save(); ctx.translate(umbrellaBoss.x + 80, umbrellaBoss.y + 60);
            ctx.rotate(umbrellaBoss.rotation);
            ctx.fillStyle = '#2980b9'; ctx.beginPath(); ctx.arc(0,0,70,Math.PI, 0); ctx.fill();
            ctx.restore();
        }
        if (stoneBoss.active) {
            ctx.fillStyle = '#57606f'; ctx.fillRect(stoneBoss.x, stoneBoss.y, stoneBoss.w, stoneBoss.h);
            ctx.fillStyle = 'red'; ctx.fillRect(stoneBoss.x+30, stoneBoss.y+40, 20, 20); ctx.fillRect(stoneBoss.x+100, stoneBoss.y+40, 20, 20);
        }
        if (voidBoss.active) {
            ctx.shadowBlur = 20; ctx.shadowColor = "#a29bfe";
            ctx.fillStyle = '#2f3542'; ctx.beginPath(); ctx.arc(voidBoss.x+75, voidBoss.y+75, 70, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(voidBoss.x+75, voidBoss.y+75, 20, 0, Math.PI*2); ctx.fill();
        }

        ctx.shadowBlur = 0;
        ctx.fillStyle = player.invul % 4 > 1 ? 'transparent' : 'white';
        ctx.fillRect(player.x, player.y, player.w, player.h);
        pBullets.forEach(b => { ctx.fillStyle = '#55efc4'; ctx.fillRect(b.x, b.y, b.size, b.size); });
        bBullets.forEach(b => { ctx.fillStyle = b.color; ctx.fillRect(b.x, b.y, b.size, b.size); });
    }
    else {
        ctx.fillStyle = 'black'; ctx.fillRect(0,0,800,450);
        ctx.fillStyle = 'white'; ctx.textAlign='center'; ctx.font='60px Arial Black';
        ctx.fillText(gameState==='WIN'?'KNOCKOUT!':'GAME OVER', 400, 225);
    }
    ctx.restore();
    requestAnimationFrame(() => { update(); draw(); });
}

function drawBossBody(x, y, r, color) {
    ctx.fillStyle = color; ctx.shadowBlur = 15; ctx.shadowColor = color;
    ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fill();
    ctx.shadowBlur = 0;
}

function drawIcon(x, y, color, label, unlocked) {
    ctx.fillStyle = unlocked ? color : '#333';
    ctx.shadowBlur = unlocked ? 15 : 0; ctx.shadowColor = color;
    ctx.fillRect(x - 50, y - 50, 100, 100);
    ctx.shadowBlur = 0;
    ctx.fillStyle = 'white'; ctx.font = '14px Arial Black'; ctx.textAlign='center';
    ctx.fillText(unlocked ? label : 'LOCKED ðŸ”’', x, y + 75);
}

draw();
</script>
</body>
</html>
