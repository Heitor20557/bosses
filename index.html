<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Floral Fury: Island Adventures</title>
    <style>
        body { margin: 0; background: #1a1a1a; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; font-family: 'Arial Black', sans-serif; }
        canvas { background: #5c8cae; border: 6px solid #222; box-shadow: 0 0 50px #000; cursor: crosshair; }
        #hud { position: absolute; top: 20px; left: 20px; color: #ff3e3e; font-size: 24px; text-shadow: 2px 2px #000; display: none; pointer-events: none; }
    </style>
</head>
<body>

<div id="hud">HP: <span id="hp-val">3</span> | BOSS: <span id="boss-lvl">---</span></div>
<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = 800; canvas.height = 450;

let gameState = 'MENU';
const keys = {};

// Sistema de Mouse para clicar nos Bosses
window.addEventListener('mousedown', e => {
    if (gameState === 'HUB') {
        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;
        
        // Clicar na Flor
        if (mouseX > 100 && mouseX < 200 && mouseY > 200 && mouseY < 300) startBoss(1);
        // Clicar no Guarda-Chuva
        if (mouseX > 350 && mouseX < 450 && mouseY > 100 && mouseY < 200) startBoss(2);
        // Clicar na Pedra
        if (mouseX > 600 && mouseX < 700 && mouseY > 200 && mouseY < 300) startBoss(3);
    }
});

window.addEventListener('keydown', e => {
    keys[e.code] = true;
    if (gameState === 'MENU' && e.code === 'Enter') gameState = 'HUB';
    else if ((gameState === 'GAMEOVER' || gameState === 'WIN') && e.code === 'Enter') {
        gameState = 'HUB';
    }
});
window.addEventListener('keyup', e => keys[e.code] = false);

let player, boss, umbrellaBoss, stoneBoss, pBullets, bBullets, platforms;

// Inicialização segura
player = { x: 100, y: 300, w: 35, h: 50, vx: 0, vy: 0, speed: 5, jump: -14, grounded: false, hp: 3, shootTimer: 0, invul: 0, dashTimer: 0, isDashing: false };
boss = { active: false, isDying: false };
umbrellaBoss = { active: false, isDying: false };
stoneBoss = { active: false, hp: 200, phase: 1, attackTimer: 0, x: 550, y: 150, w: 150, h: 200, isDying: false };
pBullets = []; bBullets = [];

function startBoss(id) {
    player = { x: 100, y: 300, w: 35, h: 50, vx: 0, vy: 0, speed: 5, jump: -14, grounded: false, hp: 3, shootTimer: 0, invul: 0, dashTimer: 0, isDashing: false };
    pBullets = []; bBullets = [];
    platforms = [{x: 80, y: 310, w: 100, h: 15}, {x: 230, y: 230, w: 100, h: 15}, {x: 380, y: 310, w: 100, h: 15}];
    
    boss.active = false; umbrellaBoss.active = false; stoneBoss.active = false;
    boss.isDying = false; umbrellaBoss.isDying = false; stoneBoss.isDying = false;

    if (id === 1) {
        boss = { x: 550, y: 70, w: 180, h: 160, hp: 100, phase: 1, attackTimer: 0, active: true, isDying: false };
        document.getElementById('boss-lvl').innerText = "FLOR FASE 1";
    } else if (id === 2) {
        umbrellaBoss = { x: 400, y: 50, w: 160, h: 120, hp: 150, phase: 1, attackTimer: 0, active: true, vx: 3, vy: 2, isDying: false, rotation: 0 };
        document.getElementById('boss-lvl').innerText = "UMBRELLA FASE 1";
    } else if (id === 3) {
        stoneBoss = { x: 550, y: 210, w: 150, h: 200, hp: 200, phase: 1, attackTimer: 0, active: true, isDying: false };
        document.getElementById('boss-lvl').innerText = "STONE FASE 1";
    }
    
    gameState = 'PLAYING';
    document.getElementById('hud').style.display = 'block';
    updateHUD();
}

function updateHUD() { document.getElementById('hp-val').innerText = player.hp; }

function checkRectCollision(a, b) {
    let bw = b.w || b.size || 10;
    let bh = b.h || b.size || 10;
    return a.x < b.x + bw && a.x + (a.w || 35) > b.x && a.y < b.y + bh && a.y + (a.h || 50) > b.y;
}

function update() {
    if (gameState === 'HUB') {
        if (keys['ArrowLeft']) player.x -= 4;
        if (keys['ArrowRight']) player.x += 4;
        if (keys['ArrowUp']) player.y -= 4;
        if (keys['ArrowDown']) player.y += 4;
        return;
    }

    if (gameState !== 'PLAYING') return;

    // --- LÓGICA DO PLAYER (MANTIDA) ---
    if (keys['KeyC'] && player.dashTimer <= 0) { player.isDashing = true; player.dashTimer = 40; player.invul = 15; }
    if (player.isDashing) { player.vx = 15; if (player.dashTimer < 25) player.isDashing = false; } 
    else {
        if (keys['ArrowLeft']) player.vx = -player.speed;
        else if (keys['ArrowRight']) player.vx = player.speed;
        else player.vx = 0;
    }
    if (player.dashTimer > 0) player.dashTimer--;
    if ((keys['Space'] || keys['KeyZ']) && player.grounded) { player.vy = player.jump; player.grounded = false; }
    player.vy += 0.7; player.x += player.vx; player.y += player.vy;

    if (player.y + player.h > canvas.height - 40) { player.y = canvas.height - 40 - player.h; player.vy = 0; player.grounded = true; }
    platforms.forEach(p => { if (player.vy > 0 && checkRectCollision(player, p) && player.y + player.h < p.y + 15) { player.y = p.y - player.h; player.vy = 0; player.grounded = true; } });

    if (keys['KeyX'] && player.shootTimer <= 0) { pBullets.push({x: player.x + player.w, y: player.y + 15, size: 8}); player.shootTimer = 10; }
    if (player.shootTimer > 0) player.shootTimer--;

    pBullets.forEach((b, i) => {
        b.x += 12;
        if (boss.active && !boss.isDying && checkRectCollision(b, boss)) { boss.hp -= 1.2; pBullets.splice(i, 1); } 
        else if (umbrellaBoss.active && !umbrellaBoss.isDying && checkRectCollision(b, umbrellaBoss)) { umbrellaBoss.hp -= 1.5; pBullets.splice(i, 1); }
        else if (stoneBoss.active && !stoneBoss.isDying && checkRectCollision(b, stoneBoss)) { stoneBoss.hp -= 1.5; pBullets.splice(i, 1); }
        else if (b.x > canvas.width) pBullets.splice(i, 1);
    });

    // --- LÓGICA BOSS 1: FLOR (MANTIDA) ---
    if (boss.active) {
        if (boss.isDying) { boss.y += 5; if (boss.y > 500) gameState = 'WIN'; }
        else {
            boss.attackTimer++;
            if (boss.hp < 66 && boss.phase === 1) { boss.phase = 2; document.getElementById('boss-lvl').innerText = "FLOR FASE 2"; }
            if (boss.hp < 33 && boss.phase === 2) { boss.phase = 3; document.getElementById('boss-lvl').innerText = "FLOR FASE FINAL"; }
            if (boss.phase === 1 && boss.attackTimer % 90 === 0) bBullets.push({x: boss.x, y: 150, vx: -6, vy: 0, size: 20, color: 'orange'});
            else if (boss.phase === 2 && boss.attackTimer % 70 === 0) { let ang = Math.atan2(player.y - 150, player.x - boss.x); bBullets.push({x: boss.x, y: 150, vx: Math.cos(ang)*7, vy: Math.sin(ang)*7, size: 15, color: 'yellow'}); }
            else if (boss.phase === 3 && boss.attackTimer % 50 === 0) bBullets.push({x: player.x, y: 0, vx: 0, vy: 8, size: 25, color: '#ff00ff'});
            if (boss.hp <= 0) { boss.isDying = true; bBullets = []; }
        }
    } 
    
    // --- LÓGICA BOSS 2: UMBRELLA (MANTIDA) ---
    else if (umbrellaBoss.active) {
        if (umbrellaBoss.isDying) { umbrellaBoss.rotation += 0.4; umbrellaBoss.y -= 5; if (umbrellaBoss.y < -200) gameState = 'WIN'; }
        else {
            umbrellaBoss.attackTimer++;
            if (umbrellaBoss.phase === 1) {
                umbrellaBoss.x += umbrellaBoss.vx; umbrellaBoss.y = 50 + Math.sin(umbrellaBoss.attackTimer * 0.05) * 30;
                if (umbrellaBoss.x > 600 || umbrellaBoss.x < 50) umbrellaBoss.vx *= -1;
                if (umbrellaBoss.attackTimer % 50 === 0) bBullets.push({x: umbrellaBoss.x + 80, y: umbrellaBoss.y + 100, vx: 0, vy: 5, size: 12, color: '#3498db'});
            } 
            else if (umbrellaBoss.phase === 2) {
                if (umbrellaBoss.attackTimer % 120 < 60) { umbrellaBoss.x += (player.x - umbrellaBoss.x) * 0.05; umbrellaBoss.y += (30 - umbrellaBoss.y) * 0.1; umbrellaBoss.w = 60; } 
                else { umbrellaBoss.y += 15; if (umbrellaBoss.y > 450) umbrellaBoss.y = -100; umbrellaBoss.w = 60; }
                if (umbrellaBoss.attackTimer % 30 === 0) bBullets.push({x: umbrellaBoss.x, y: umbrellaBoss.y, vx: -5, vy: 0, size: 10, color: 'white'});
            }
            else if (umbrellaBoss.phase === 3) {
                umbrellaBoss.x += (320 - umbrellaBoss.x) * 0.05; umbrellaBoss.y += (100 - umbrellaBoss.y) * 0.05; umbrellaBoss.w = 160;
                if (player.x < umbrellaBoss.x + 80) player.x += 1; else player.x -= 1;
                if (umbrellaBoss.attackTimer % 20 === 0) { let ang = Math.random() * Math.PI * 2; bBullets.push({x: umbrellaBoss.x + 80, y: umbrellaBoss.y + 50, vx: Math.cos(ang)*6, vy: Math.sin(ang)*6, size: 10, color: '#f1c40f'}); }
            }
            if (umbrellaBoss.hp < 100 && umbrellaBoss.phase === 1) umbrellaBoss.phase = 2;
            if (umbrellaBoss.hp < 50 && umbrellaBoss.phase === 2) umbrellaBoss.phase = 3;
            if (umbrellaBoss.hp <= 0) { umbrellaBoss.isDying = true; bBullets = []; }
        }
    }

    // --- NOVO BOSS 3: STONE ---
    else if (stoneBoss.active) {
        if (stoneBoss.isDying) { stoneBoss.y += 2; if (stoneBoss.y > 500) gameState = 'WIN'; }
        else {
            stoneBoss.attackTimer++;
            if (stoneBoss.phase === 1 && stoneBoss.attackTimer % 100 === 0) {
                // Onda de choque no chão
                bBullets.push({x: 800, y: 380, vx: -8, vy: 0, size: 40, color: '#7f8c8d'});
            }
            else if (stoneBoss.phase === 2 && stoneBoss.attackTimer % 40 === 0) {
                // Chuva de pedras
                bBullets.push({x: Math.random() * 500, y: -50, vx: 0, vy: 6, size: 30, color: '#34495e'});
            }
            else if (stoneBoss.phase === 3 && stoneBoss.attackTimer % 60 === 0) {
                // Pedras teleguiadas
                let ang = Math.atan2(player.y - stoneBoss.y, player.x - stoneBoss.x);
                bBullets.push({x: stoneBoss.x, y: stoneBoss.y, vx: Math.cos(ang)*5, vy: Math.sin(ang)*5, size: 20, color: '#2c3e50'});
            }
            if (stoneBoss.hp < 140 && stoneBoss.phase === 1) stoneBoss.phase = 2;
            if (stoneBoss.hp < 70 && stoneBoss.phase === 2) stoneBoss.phase = 3;
            if (stoneBoss.hp <= 0) stoneBoss.isDying = true;
        }
    }

    bBullets.forEach((b, i) => {
        b.x += (b.vx || 0); b.y += (b.vy || 0);
        if (checkRectCollision(b, player) && player.invul <= 0) { player.hp--; player.invul = 60; updateHUD(); bBullets.splice(i, 1); }
        if (b.x < -100 || b.x > 900 || b.y > canvas.height + 50) bBullets.splice(i, 1);
    });

    if (player.invul > 0) player.invul--;
    if (player.hp <= 0) gameState = 'GAMEOVER';
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (gameState === 'MENU') {
        ctx.fillStyle = '#2c3e50'; ctx.fillRect(0,0,800,450);
        ctx.fillStyle = 'white'; ctx.textAlign = 'center'; ctx.font = '40px Arial Black';
        ctx.fillText('FLORAL FURY: ISLAND', 400, 200);
        ctx.font = '20px Arial'; ctx.fillText('PRESS ENTER TO ENTER THE ISLAND', 400, 260);
    } 
    else if (gameState === 'HUB') {
        // Desenho da Ilha
        ctx.fillStyle = '#2ecc71'; ctx.fillRect(0,0,800,450); // Grama
        ctx.fillStyle = '#f1c40f'; ctx.beginPath(); ctx.arc(400,225,300,0,Math.PI*2); ctx.fill(); // Areia
        
        // Ícones dos Bosses
        ctx.fillStyle = '#e74c3c'; ctx.fillRect(100, 200, 100, 100); ctx.fillStyle='white'; ctx.font='15px Arial'; ctx.fillText('FLOWER', 150, 320);
        ctx.fillStyle = '#3498db'; ctx.fillRect(350, 100, 100, 100); ctx.fillText('UMBRELLA', 400, 220);
        ctx.fillStyle = '#95a5a6'; ctx.fillRect(600, 200, 100, 100); ctx.fillText('STONE', 650, 320);

        ctx.fillStyle = 'black'; ctx.font='20px Arial'; ctx.fillText('USE SETAS PARA ANDAR E CLIQUE NO BOSS PARA LUTAR', 400, 400);
        
        // Player no Mapa
        ctx.fillStyle = 'red'; ctx.fillRect(player.x, player.y, 20, 20);
    }
    else if (gameState === 'PLAYING') {
        ctx.fillStyle = '#4e7a2a'; ctx.fillRect(0, canvas.height - 40, canvas.width, 40);
        ctx.fillStyle = '#ff69b4'; platforms.forEach(p => ctx.fillRect(p.x, p.y, p.w, p.h));
        
        if (boss.active) {
            ctx.fillStyle = '#2d5a27'; ctx.fillRect(boss.x + 80, 230, 30, 250);
            ctx.fillStyle = boss.phase === 3 ? '#8b0000' : '#ff8c00';
            ctx.beginPath(); ctx.arc(boss.x + 90, 150, 80, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#f7e442'; ctx.fillRect(boss.x + 50, 110, 80, 80);
        }
        if (umbrellaBoss.active) {
            ctx.save(); ctx.translate(umbrellaBoss.x + umbrellaBoss.w/2, umbrellaBoss.y + 50);
            ctx.rotate(umbrellaBoss.rotation || 0);
            ctx.fillStyle = '#2e86c1'; ctx.beginPath(); ctx.arc(0, 0, umbrellaBoss.w/2, Math.PI, 0); ctx.fill();
            ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(0, 80); ctx.stroke(); ctx.restore();
        }
        if (stoneBoss.active) {
            ctx.fillStyle = '#7f8c8d'; ctx.fillRect(stoneBoss.x, stoneBoss.y, stoneBoss.w, stoneBoss.h);
            ctx.fillStyle = 'red'; ctx.fillRect(stoneBoss.x + 20, stoneBoss.y + 40, 20, 20); ctx.fillRect(stoneBoss.x + 110, stoneBoss.y + 40, 20, 20);
        }

        ctx.fillStyle = player.invul % 4 > 1 ? 'transparent' : 'red';
        ctx.fillRect(player.x, player.y, player.w, player.h);
        ctx.fillStyle = '#00f2ff'; pBullets.forEach(b => ctx.fillRect(b.x, b.y, b.size, b.size));
        bBullets.forEach(b => { ctx.fillStyle = b.color; ctx.fillRect(b.x, b.y, b.size, b.size); });
    }
    else {
        ctx.fillStyle = 'black'; ctx.fillRect(0,0,800,450);
        ctx.fillStyle = 'white'; ctx.textAlign = 'center'; ctx.font = '60px Arial Black';
        ctx.fillText(gameState === 'WIN' ? 'KNOCKOUT!' : 'GAME OVER', 400, 200);
        ctx.font = '20px Arial'; ctx.fillText('PRESS ENTER TO GO BACK TO ISLAND', 400, 280);
    }
    requestAnimationFrame(() => { update(); draw(); });
}
draw();
</script>
</body>
</html>
