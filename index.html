<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Cuphead: Floral Fury JS</title>
    <style>
        body { margin: 0; background: #111; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; font-family: 'Georgia', serif; }
        canvas { background: linear-gradient(#4a90e2, #2d5a27); border: 6px solid #333; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        #hud { position: absolute; top: 20px; color: white; text-align: center; width: 800px; font-weight: bold; text-shadow: 2px 2px #000; z-index: 10; }
        .phase-txt { font-style: italic; color: #ffcc00; font-size: 14px; }
    </style>
</head>
<body>

<div id="hud">
    HP: <span id="hp" style="color: #ff4d4d;">3</span> | 
    BOSS: <span id="boss-hp" style="color: #ffcc00;">100</span>% <br>
    <span id="phase-label" class="phase-txt">FASE 1: SEMENTES VIVAS</span>
</div>
<canvas id="game"></canvas>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = 800;
canvas.height = 450;

const GRAVITY = 0.5;
const keys = {};

window.addEventListener('keydown', e => keys[e.code] = true);
window.addEventListener('keyup', e => keys[e.code] = false);

class Player {
    constructor() {
        this.x = 100; this.y = 300;
        this.w = 30; this.h = 45;
        this.vx = 0; this.vy = 0;
        this.speed = 5;
        this.jumpPower = -11;
        this.grounded = false;
        this.hp = 3;
        this.shootTimer = 0;
        this.invincibility = 0;
    }

    update() {
        if (keys['ArrowLeft']) this.vx = -this.speed;
        else if (keys['ArrowRight']) this.vx = this.speed;
        else this.vx = 0;

        if (keys['KeyZ'] && this.grounded) {
            this.vy = this.jumpPower;
            this.grounded = false;
        }

        this.vy += GRAVITY;
        this.x += this.vx;
        this.y += this.vy;

        if (this.y + this.h > canvas.height - 40) {
            this.y = canvas.height - 40 - this.h;
            this.vy = 0;
            this.grounded = true;
        }

        if (this.x < 0) this.x = 0;
        if (this.x > 500) this.x = 500; // Limite para não encostar no corpo do Boss
        if (this.shootTimer > 0) this.shootTimer--;
        if (this.invincibility > 0) this.invincibility--;
    }

    draw() {
        ctx.globalAlpha = this.invincibility % 2 === 0 ? 1 : 0.5;
        ctx.fillStyle = '#3498db'; // Cuphead Azul (para variar)
        ctx.fillRect(this.x, this.y, this.w, this.h);
        ctx.fillStyle = 'white';
        ctx.fillRect(this.x - 5, this.y - 10, this.w + 10, 15);
        ctx.globalAlpha = 1;
    }
}

class Boss {
    constructor() {
        this.x = 600; this.y = 120;
        this.w = 130; this.h = 250;
        this.hp = 100;
        this.phase = 1;
        this.attackTimer = 0;
        this.state = 'idle'; // idle, lunging, shooting
        this.color = '#ff9800';
    }

    update() {
        this.attackTimer++;

        // Gerenciamento de Fases
        if (this.hp <= 70 && this.phase === 1) {
            this.phase = 2;
            this.color = '#e67e22';
            document.getElementById('phase-label').innerText = "FASE 2: ATAQUE DE PÓLEN";
        }
        if (this.hp <= 30 && this.phase === 2) {
            this.phase = 3;
            this.color = '#8e44ad';
            document.getElementById('phase-label').innerText = "FASE 3: FÚRIA DAS VIDEIRAS";
        }

        // Lógica de Ataques por Fase
        if (this.phase === 1 && this.attackTimer % 100 === 0) this.shootAtPlayer();
        if (this.phase === 2 && this.attackTimer % 80 === 0) {
            Math.random() > 0.5 ? this.shootAtPlayer() : this.lungeAttack();
        }
        if (this.phase === 3) {
            if (this.attackTimer % 60 === 0) this.shootAtPlayer();
            if (this.attackTimer % 120 === 0) this.vineAttack();
        }
    }

    shootAtPlayer() {
        // Atira direto na posição do jogador
        const dx = player.x - this.x;
        const dy = player.y - (this.y + 50);
        const angle = Math.atan2(dy, dx);
        bossProjectiles.push(new Projectile(this.x, this.y + 50, Math.cos(angle) * 6, Math.sin(angle) * 6, 'orange', 15));
    }

    lungeAttack() {
        // O "Face Stretch" - Ataca a linha horizontal
        this.state = 'lunging';
        setTimeout(() => {
            bossProjectiles.push(new Projectile(this.x, player.y, -12, 0, '#f1c40f', 40));
            this.state = 'idle';
        }, 500);
    }

    vineAttack() {
        // Ataque de espinhos no chão
        bossProjectiles.push(new Projectile(player.x, canvas.height - 40, 0, -5, '#27ae60', 30));
    }

    draw() {
        ctx.fillStyle = this.color;
        // Cabeça da Flor
        ctx.beginPath();
        ctx.arc(this.x + 65, this.y + 60, 70, 0, Math.PI * 2);
        ctx.fill();
        // Rosto
        ctx.fillStyle = 'yellow';
        ctx.fillRect(this.x + 30, this.y + 40, 40, 40);
        // Caule
        ctx.fillStyle = '#2d5a27';
        ctx.fillRect(this.x + 55, this.y + 130, 20, 300);
    }
}

class Projectile {
    constructor(x, y, vx, vy, color, size) {
        this.x = x; this.y = y;
        this.vx = vx; this.vy = vy;
        this.color = color;
        this.size = size;
    }
    update() { this.x += this.vx; this.y += this.vy; }
    draw() {
        ctx.fillStyle = this.color;
        ctx.fillRect(this.x, this.y, this.size, this.size);
    }
}

// Inicialização
const player = new Player();
const boss = new Boss();
const playerBullets = [];
const bossProjectiles = [];
// Plataformas em altura que o personagem alcança (Pulo = 120px aprox)
const platforms = [
    {x: 80, y: 280, w: 90, h: 15},
    {x: 230, y: 210, w: 90, h: 15},
    {x: 380, y: 280, w: 90, h: 15}
];

function checkCol(r1, r2) {
    const r2w = r2.w || r2.size;
    const r2h = r2.h || r2.size;
    return r1.x < r2.x + r2w && r1.x + r1.w > r2.x && r1.y < r2.y + r2h && r1.y + r1.h > r2.y;
}

function loop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Chão
    ctx.fillStyle = '#1e3d14';
    ctx.fillRect(0, canvas.height - 40, canvas.width, 40);

    // Plataformas
    ctx.fillStyle = '#ff69b4';
    platforms.forEach(p => {
        ctx.fillRect(p.x, p.y, p.w, p.h);
        if (player.vy > 0 && checkCol(player, p) && (player.y + player.h) < p.y + 15) {
            player.y = p.y - player.h;
            player.vy = 0;
            player.grounded = true;
        }
    });

    // Ataque Player
    if (keys['KeyX'] && player.shootTimer === 0) {
        playerBullets.push(new Projectile(player.x + player.w, player.y + 10, 12, 0, '#55ffff', 8));
        player.shootTimer = 12;
    }

    player.update();
    boss.update();

    // Balas do Cuphead -> Boss
    playerBullets.forEach((b, i) => {
        b.update(); b.draw();
        if (checkCol(b, boss)) {
            boss.hp -= 1;
            playerBullets.splice(i, 1);
            document.getElementById('boss-hp').innerText = Math.max(0, boss.hp);
        }
        if (b.x > canvas.width) playerBullets.splice(i, 1);
    });

    // Ataques do Boss -> Player
    bossProjectiles.forEach((p, i) => {
        p.update(); p.draw();
        if (checkCol(p, player) && player.invincibility === 0) {
            player.hp -= 1;
            player.invincibility = 60;
            bossProjectiles.splice(i, 1);
            document.getElementById('hp').innerText = player.hp;
            if (player.hp <= 0) { location.reload(); alert("VOCÊ PERDEU!"); }
        }
        if (p.x < -50 || p.y < -50 || p.y > canvas.height) bossProjectiles.splice(i, 1);
    });

    player.draw();
    boss.draw();

    if (boss.hp > 0) requestAnimationFrame(loop);
    else { ctx.fillStyle = "white"; ctx.font = "50px Arial"; ctx.fillText("KNOCKOUT!", 250, 200); }
}

loop();
</script>
</body>
</html>
