<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Floral Fury - Final Version</title>
    <style>
        body { margin: 0; background: #000; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; font-family: sans-serif; }
        canvas { background: #334d5c; border: 4px solid #fff; }
        #ui { position: absolute; top: 10px; left: 10px; color: #fff; font-size: 20px; font-weight: bold; pointer-events: none; }
    </style>
</head>
<body>

<div id="ui">HP: <span id="hp">3</span> | BOSS: <span id="boss-name">FLOR</span></div>
<canvas id="game"></canvas>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = 800; canvas.height = 450;

// CONFIGURAÇÕES GERAIS
let gameState = 'START';
let checkpoint = 1;
const keys = {};

// PLAYER
let player = {
    x: 100, y: 300, w: 30, h: 45, 
    vx: 0, vy: 0, 
    speed: 5, jump: -15, 
    hp: 3, invul: 0, dash: 0
};

// BOSSES
let activeBoss = null;
const bosses = {
    flor: { name: "FLOR", hp: 100, maxHp: 100, x: 650, y: 150, r: 50, phase: 1, timer: 0 },
    umbrella: { name: "GUARDA-CHUVA", hp: 120, maxHp: 120, x: 400, y: 100, w: 120, h: 60, phase: 1, timer: 0, vx: 3 },
    cloud: { name: "NUVEM", hp: 150, maxHp: 150, x: 400, y: 80, w: 180, h: 80, phase: 1, timer: 0, laser: 0 }
};

let bullets = [];
let pBullets = [];
const platforms = [
    {x: 100, y: 320, w: 120, h: 15},
    {x: 340, y: 240, w: 120, h: 15},
    {x: 580, y: 320, w: 120, h: 15}
];

// CONTROLES
window.onkeydown = e => { 
    keys[e.code] = true; 
    if(e.code === 'Enter') {
        if(gameState === 'START' || gameState === 'GAMEOVER') startLevel(1);
        if(gameState === 'WIN') startLevel(1);
        if(gameState === 'CLEAR') startLevel(checkpoint);
    }
};
window.onkeyup = e => keys[e.code] = false;

function startLevel(lvl) {
    checkpoint = lvl;
    player.hp = 3; player.x = 100; player.y = 300; player.vx = 0; player.vy = 0;
    bullets = []; pBullets = [];
    
    if(lvl === 1) { activeBoss = {...bosses.flor}; document.getElementById('boss-name').innerText = "FLOR"; }
    if(lvl === 2) { activeBoss = {...bosses.umbrella}; document.getElementById('boss-name').innerText = "GUARDA-CHUVA"; }
    if(lvl === 3) { activeBoss = {...bosses.cloud}; document.getElementById('boss-name').innerText = "NUVEM"; }
    
    gameState = 'PLAYING';
}

function checkCol(r1, r2) {
    return r1.x < r2.x + r2.w && r1.x + r1.w > r2.x && r1.y < r2.y + r2.h && r1.y + r1.h > r2.y;
}

function update() {
    if(gameState !== 'PLAYING') return;

    // Movimento Player
    if(keys['ArrowLeft']) player.vx = -player.speed;
    else if(keys['ArrowRight']) player.vx = player.speed;
    else player.vx = 0;

    if(keys['Space'] && player.grounded) { player.vy = player.jump; player.grounded = false; }
    
    player.vy += 0.8; // Gravidade
    player.x += player.vx;
    player.y += player.vy;
    player.grounded = false;

    // Colisão Chão/Plataformas
    if(player.y + player.h > 410) { player.y = 410 - player.h; player.vy = 0; player.grounded = true; }
    platforms.forEach(p => {
        if(player.vy > 0 && checkCol(player, p) && player.y + player.h < p.y + 20) {
            player.y = p.y - player.h; player.vy = 0; player.grounded = true;
        }
    });

    // Tiros Player
    if(keys['KeyX'] && player.dash <= 0) {
        pBullets.push({x: player.x + player.w, y: player.y + 10, w: 10, h: 6});
        player.dash = 10;
    }
    if(player.dash > 0) player.dash--;

    pBullets.forEach((b, i) => {
        b.x += 10;
        let bossHitbox = {x: activeBoss.x - (activeBoss.r || activeBoss.w/2), y: activeBoss.y, w: activeBoss.w || activeBoss.r*2, h: activeBoss.h || activeBoss.r*2};
        if(checkCol(b, bossHitbox)) {
            activeBoss.hp -= 2;
            pBullets.splice(i, 1);
        }
    });

    // LÓGICA DOS CHEFES
    activeBoss.timer++;
    
    // Flor
    if(activeBoss.name === "FLOR") {
        if(activeBoss.hp < 50) activeBoss.phase = 2;
        if(activeBoss.timer % (activeBoss.phase === 1 ? 60 : 40) === 0) {
            bullets.push({x: activeBoss.x, y: activeBoss.y + 20, vx: -6, vy: 0, w: 15, h: 15, color: 'orange'});
        }
    }

    // Guarda-Chuva
    if(activeBoss.name === "GUARDA-CHUVA") {
        activeBoss.x += activeBoss.vx;
        if(activeBoss.x < 100 || activeBoss.x > 700) activeBoss.vx *= -1;
        // Dano por contato
        let hit = {x: activeBoss.x - 60, y: activeBoss.y, w: 120, h: 60};
        if(checkCol(player, hit) && player.invul <= 0) { player.hp--; player.invul = 60; }
        
        if(activeBoss.timer % 50 === 0) bullets.push({x: activeBoss.x, y: activeBoss.y + 60, vx: 0, vy: 5, w: 12, h: 20, color: 'cyan'});
    }

    // Nuvem
    if(activeBoss.name === "NUVEM") {
        activeBoss.x += Math.sin(activeBoss.timer * 0.05) * 5;
        if(activeBoss.hp < 75) activeBoss.phase = 2;
        
        if(activeBoss.phase === 2 && activeBoss.timer % 200 === 0) activeBoss.laser = 90;
        if(activeBoss.laser > 0) {
            activeBoss.laser--;
            if(activeBoss.laser < 30) {
                let lRect = {x: activeBoss.x - 20, y: 0, w: 40, h: 450};
                if(checkCol(player, lRect) && player.invul <= 0) { player.hp--; player.invul = 60; }
            }
        }
        if(activeBoss.timer % 40 === 0) bullets.push({x: activeBoss.x, y: activeBoss.y + 40, vx: 0, vy: 7, w: 10, h: 10, color: 'yellow'});
    }

    // Balas Inimigas
    bullets.forEach((b, i) => {
        b.x += b.vx; b.y += b.vy;
        if(checkCol(b, player) && player.invul <= 0) {
            player.hp--; player.invul = 60;
            bullets.splice(i, 1);
        }
    });

    // Status
    if(player.invul > 0) player.invul--;
    document.getElementById('hp').innerText = player.hp;
    
    if(player.hp <= 0) gameState = 'GAMEOVER';
    if(activeBoss.hp <= 0) {
        if(checkpoint === 3) gameState = 'WIN';
        else { checkpoint++; gameState = 'CLEAR'; }
    }
}

function draw() {
    ctx.clearRect(0, 0, canvas.width,
