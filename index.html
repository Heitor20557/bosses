<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Cuphead Boss Fight - Final Version</title>
    <style>
        body { margin: 0; background: #000; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; font-family: 'Arial Black', sans-serif; }
        canvas { background: #2d5a27; border: 5px solid #fbff00; box-shadow: 0 0 40px rgba(255, 204, 0, 0.4); }
        #ui { position: absolute; top: 20px; color: white; width: 800px; display: flex; justify-content: space-around; text-shadow: 2px 2px #000; pointer-events: none; }
        .meter-bg { width: 150px; height: 15px; background: #333; border: 2px solid #fff; }
        #special-bar { width: 0%; height: 100%; background: #00f2ff; transition: width 0.1s; }
    </style>
</head>
<body>

<div id="ui">
    <div>HP: <span id="hp" style="color: #ff3e3e;">3</span></div>
    <div>BOSS: <span id="boss-hp" style="color: #ffd700;">100</span>%</div>
    <div>ESPECIAL (C): <div class="meter-bg"><div id="special-bar"></div></div></div>
</div>
<canvas id="game"></canvas>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = 800;
canvas.height = 450;

const GRAVITY = 0.4; // Gravidade mais leve
const keys = {};

window.addEventListener('keydown', e => keys[e.code] = true);
window.addEventListener('keyup', e => keys[e.code] = false);

class Player {
    constructor() {
        this.x = 100; this.y = 300;
        this.w = 35; this.h = 50;
        this.vx = 0; this.vy = 0;
        this.speed = 6;
        this.jumpPower = -12.5; // Pulo mais forte
        this.grounded = false;
        this.hp = 3;
        this.specialMeter = 0;
        this.shootTimer = 0;
        this.invincibility = 0;
    }

    update() {
        if (keys['ArrowLeft']) this.vx = -this.speed;
        else if (keys['ArrowRight']) this.vx = this.speed;
        else this.vx = 0;

        if (keys['KeyZ'] && this.grounded) {
            this.vy = this.jumpPower;
            this.grounded = false;
        }

        this.vy += GRAVITY;
        this.x += this.vx;
        this.y += this.vy;

        // Chão sólido
        if (this.y + this.h > canvas.height - 40) {
            this.y = canvas.height - 40 - this.h;
            this.vy = 0;
            this.grounded = true;
        }

        if (this.x < 0) this.x = 0;
        if (this.x > 500) this.x = 500;
        if (this.shootTimer > 0) this.shootTimer--;
        if (this.invincibility > 0) this.invincibility--;
    }

    draw() {
        ctx.save();
        if (this.invincibility > 0) ctx.globalAlpha = 0.5;
        ctx.fillStyle = '#ff0000'; // Corpo Cuphead
        ctx.fillRect(this.x, this.y, this.w, this.h);
        ctx.fillStyle = '#fff'; // Cabeça
        ctx.fillRect(this.x - 5, this.y - 12, this.w + 10, 18);
        ctx.restore();
    }
}

class Boss {
    constructor() {
        this.x = 580; this.y = 80;
        this.w = 180; this.h = 300;
        this.hp = 100;
        this.attackTimer = 0;
    }

    update() {
        this.attackTimer++;
        if (this.attackTimer % 70 === 0) this.shootLeaf();
    }

    shootLeaf() {
        // Atira folha que segue o jogador
        const angle = Math.atan2(player.y - this.y - 100, player.x - this.x);
        bossProjectiles.push(new Projectile(this.x, this.y + 100, Math.cos(angle) * 5, Math.sin(angle) * 5, '#46aa2d', 20));
    }

    draw() {
        ctx.fillStyle = '#ff9100'; // Pétalas
        ctx.beginPath();
        ctx.arc(this.x + 90, this.y + 90, 85, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#f7e442'; // Rosto
        ctx.fillRect(this.x + 50, this.y + 50, 80, 80);
        ctx.fillStyle = '#225a1f'; // Caule
        ctx.fillRect(this.x + 80, this.y + 175, 25, 250);
    }
}

class Projectile {
    constructor(x, y, vx, vy, color, size, isSuper = false) {
        this.x = x; this.y = y;
        this.vx = vx; this.vy = vy;
        this.color = color;
        this.size = size;
        this.isSuper = isSuper;
    }
    update() { this.x += this.vx; this.y += this.vy; }
    draw() {
        ctx.fillStyle = this.color;
        ctx.shadowBlur = this.isSuper ? 15 : 0;
        ctx.shadowColor = this.color;
        ctx.fillRect(this.x, this.y, this.size, this.size);
        ctx.shadowBlur = 0;
    }
}

const player = new Player();
const boss = new Boss();
const playerProjectiles = [];
const bossProjectiles = [];

// Plataformas em alturas acessíveis
const platforms = [
    {x: 70, y: 310, w: 100, h: 15},
    {x: 220, y: 240, w: 100, h: 15},
    {x: 370, y: 310, w: 100, h: 15}
];

function checkCol(a, b) {
    const bw = b.w || b.size;
    const bh = b.h || b.size;
    return a.x < b.x + bw && a.x + a.w > b.x && a.y < b.y + bh && a.y + a.h > b.y;
}

function loop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Fundo/Grama
    ctx.fillStyle = '#1e3d14';
    ctx.fillRect(0, canvas.height - 40, canvas.width, 40);

    // Plataformas
    ctx.fillStyle = '#ff69b4';
    platforms.forEach(p => {
        ctx.fillRect(p.x, p.y, p.w, p.h);
        if (player.vy > 0 && checkCol(player, p) && (player.y + player.h) < p.y + 18) {
            player.y = p.y - player.h;
            player.vy = 0;
            player.grounded = true;
        }
    });

    // ATAQUES PLAYER
    if (keys['KeyX'] && player.shootTimer === 0) {
        playerProjectiles.push(new Projectile(player.x + player.w, player.y + 15, 12, 0, '#00f2ff', 10));
        player.shootTimer = 10;
    }
    
    // ESPECIAL (Tecla C)
    if (keys['KeyC'] && player.specialMeter >= 100) {
        playerProjectiles.push(new Projectile(player.x + player.w, player.y - 10, 15, 0, '#fff', 40, true));
        player.specialMeter = 0;
        document.getElementById('special-bar').style.width = '0%';
    }

    player.update();
    boss.update();

    // Colisão: Tiros do Player -> Boss
    playerProjectiles.forEach((p, i) => {
        p.update(); p.draw();
        if (checkCol(p, boss)) {
            let damage = p.isSuper ? 15 : 1.5;
            boss.hp -= damage;
            if (!p.isSuper) {
                player.specialMeter = Math.min(100, player.specialMeter + 4);
                document.getElementById('special-bar').style.width = player.specialMeter + '%';
            }
            playerProjectiles.splice(i, 1);
            document.getElementById('boss-hp').innerText = Math.floor(Math.max(0, boss.hp));
        }
        if (p.x > canvas.width) playerProjectiles.splice(i, 1);
    });

    // Colisão: Tiros do Boss -> Player (DANO REAL)
    bossProjectiles.forEach((p, i) => {
        p.update(); p.draw();
        if (checkCol(p, player) && player.invincibility === 0) {
            player.hp -= 1;
            player.invincibility = 70; // Tempo piscando
            bossProjectiles.splice(i, 1);
            document.getElementById('hp').innerText = player.hp;
            if (player.hp <= 0) { alert("VOCÊ FOI DERROTADO!"); location.reload(); }
        }
        if (p.x < -50 || p.x > 850 || p.y > 500) bossProjectiles.splice(i, i);
    });

    player.draw();
    boss.draw();

    if (boss.hp > 0) requestAnimationFrame(loop);
    else {
        ctx.fillStyle = "white"; ctx.font = "60px Arial Black";
        ctx.fillText("KNOCKOUT!", 200, 220);
    }
}

loop();
</script>
</body>
</html>
