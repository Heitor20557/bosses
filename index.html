<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Floral Fury - Hardcore Edition</title>
    <style>
        body { margin: 0; background: #1a1a1a; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; font-family: 'Arial Black', sans-serif; }
        canvas { background: #4a6b8a; border: 6px solid #222; box-shadow: 0 0 50px #000; }
        #hud { position: absolute; top: 20px; left: 20px; color: #ff3e3e; font-size: 24px; text-shadow: 2px 2px #000; display: none; }
    </style>
</head>
<body>

<div id="hud">HP: <span id="hp-val">3</span> | <span id="boss-lvl">FLOR FASE 1</span></div>
<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = 800; canvas.height = 450;

let gameState = 'MENU';
let checkpoint = 1; 
const keys = {};

window.addEventListener('keydown', e => {
    keys[e.code] = true;
    if (gameState === 'MENU' && e.code === 'Enter') restartGame();
    else if (gameState === 'NEXT_BOSS_2' && e.code === 'Enter') startSecondBoss();
    else if (gameState === 'NEXT_BOSS_3' && e.code === 'Enter') startThirdBoss();
    else if (gameState === 'GAMEOVER' && e.code === 'Enter') retryBoss();
    else if (gameState === 'WIN' && e.code === 'Enter') restartGame();
});
window.addEventListener('keyup', e => keys[e.code] = false);

let player, boss, umbrellaBoss, cloudBoss, pBullets, bBullets, platforms;

function initPlayer() {
    player = { x: 100, y: 300, w: 35, h: 50, vx: 0, vy: 0, speed: 5.5, jump: -15, grounded: false, hp: 3, shootTimer: 0, invul: 0, dashTimer: 0, isDashing: false };
    pBullets = []; bBullets = [];
}

function restartGame() {
    checkpoint = 1;
    initBosses();
    initPlayer();
    gameState = 'PLAYING';
    document.getElementById('hud').style.display = 'block';
    document.getElementById('boss-lvl').innerText = "FLOR FASE 1";
    updateHUD();
}

function initBosses() {
    boss = { x: 550, y: 70, w: 180, h: 160, hp: 130, maxHp: 130, phase: 1, attackTimer: 0, active: true, isDying: false, deathTimer: 0 };
    umbrellaBoss = { x: 400, y: -200, w: 160, h: 120, hp: 180, maxHp: 180, phase: 1, attackTimer: 0, active: false, vx: 4, vy: 2, isDying: false, deathTimer: 0, rotation: 0 };
    cloudBoss = { x: 100, y: -200, w: 200, h: 100, hp: 250, maxHp: 250, phase: 1, attackTimer: 0, active: false, vx: 6, isDying: false, deathTimer: 0, laserActive: 0 };
    platforms = [{x: 80, y: 310, w: 100, h: 15}, {x: 230, y: 230, w: 100, h: 15}, {x: 380, y: 310, w: 100, h: 15}];
}

function retryBoss() {
    if (checkpoint === 1) restartGame();
    else if (checkpoint === 2) startSecondBoss();
    else if (checkpoint === 3) startThirdBoss();
}

function startSecondBoss() {
    checkpoint = 2;
    initPlayer();
    initBosses();
    boss.active = false; umbrellaBoss.active = true; umbrellaBoss.y = 50;
    gameState = 'PLAYING';
    document.getElementById('boss-lvl').innerText = "UMBRELLA FASE 1";
    updateHUD();
}

function startThirdBoss() {
    checkpoint = 3;
    initPlayer();
    initBosses();
    boss.active = false; umbrellaBoss.active = false; cloudBoss.active = true; cloudBoss.y = 60;
    gameState = 'PLAYING';
    document.getElementById('boss-lvl').innerText = "NUVEM FASE 1";
    updateHUD();
}

function updateHUD() { document.getElementById('hp-val').innerText = player.hp; }
function checkRectCollision(a, b) {
    const bw = b.w || b.size || 10;
    const bh = b.h || b.size || 10;
    return a.x < b.x + bw && a.x + a.w > b.x && a.y < b.y + bh && a.y + a.h > b.y;
}

function update() {
    if (gameState !== 'PLAYING') return;

    // Player
    if (keys['KeyC'] && player.dashTimer <= 0) { player.isDashing = true; player.dashTimer = 35; player.invul = 15; }
    if (player.isDashing) { player.vx = 16; if (player.dashTimer < 20) player.isDashing = false; } 
    else {
        if (keys['ArrowLeft']) player.vx = -player.speed;
        else if (keys['ArrowRight']) player.vx = player.speed;
        else player.vx = 0;
    }
    if (player.dashTimer > 0) player.dashTimer--;
    if ((keys['Space'] || keys['KeyZ']) && player.grounded) { player.vy = player.jump; player.grounded = false; }
    player.vy += 0.75; player.x += player.vx; player.y += player.vy;

    if (player.y + player.h > canvas.height - 40) { player.y = canvas.height - 40 - player.h; player.vy = 0; player.grounded = true; }
    platforms.forEach(p => { if (player.vy > 0 && checkRectCollision(player, p) && player.y + player.h < p.y + 15) { player.y = p.y - player.h; player.vy = 0; player.grounded = true; } });

    if (keys['KeyX'] && player.shootTimer <= 0) { pBullets.push({x: player.x + player.w, y: player.y + 15, size: 8}); player.shootTimer = 9; }
    if (player.shootTimer > 0) player.shootTimer--;

    pBullets.forEach((b, i) => {
        b.x += 13;
        if (boss.active && !boss.isDying && checkRectCollision(b, boss)) { boss.hp -= 1.5; pBullets.splice(i, 1); } 
        else if (umbrellaBoss.active && !umbrellaBoss.isDying && checkRectCollision(b, umbrellaBoss)) { umbrellaBoss.hp -= 1.8; pBullets.splice(i, 1); }
        else if (cloudBoss.active && !cloudBoss.isDying && checkRectCollision(b, cloudBoss)) { cloudBoss.hp -= 2; pBullets.splice(i, 1); }
        else if (b.x > canvas.width) pBullets.splice(i, 1);
    });

    // Lógica Flor
    if (boss.active) {
        if (boss.isDying) {
            boss.deathTimer--; boss.y += 5;
            if (boss.deathTimer <= 0) { boss.active = false; bBullets = []; gameState = 'NEXT_BOSS_2'; }
        } else {
            boss.attackTimer++;
            if (boss.hp < 90 && boss.phase === 1) { boss.phase = 2; document.getElementById('boss-lvl').innerText = "FLOR FASE 2"; }
            if (boss.hp < 45 && boss.phase === 2) { boss.phase = 3; document.getElementById('boss-lvl').innerText = "FLOR FASE FINAL"; }
            if (boss.attackTimer % 70 === 0) bBullets.push({x: boss.x, y: 150, vx: -8, vy: 0, size: 22, color: 'orange'});
            if (boss.hp <= 0) { boss.isDying = true; boss.deathTimer = 60; }
        }
    } 
    
    // Lógica Umbrella
    else if (umbrellaBoss.active) {
        if (umbrellaBoss.isDying) {
            umbrellaBoss.deathTimer--; umbrellaBoss.rotation += 0.5; umbrellaBoss.y -= 2;
            if (umbrellaBoss.deathTimer <= 0) { umbrellaBoss.active = false; bBullets = []; gameState = 'NEXT_BOSS_3'; }
        } else {
            if (checkRectCollision(player, umbrellaBoss) && player.invul <= 0) { player.hp--; player.invul = 60; updateHUD(); }
            umbrellaBoss.attackTimer++;
            if (umbrellaBoss.hp < 120 && umbrellaBoss.phase === 1) { umbrellaBoss.phase = 2; document.getElementById('boss-lvl').innerText = "UMBRELLA FASE 2"; }
            umbrellaBoss.x += umbrellaBoss.vx; if (umbrellaBoss.x > 600 || umbrellaBoss.x < 50) umbrellaBoss.vx *= -1;
            if (umbrellaBoss.attackTimer % 40 === 0) bBullets.push({x: umbrellaBoss.x + 80, y: umbrellaBoss.y + 100, vx: 0, vy: 7, size: 14, color: '#3498db'});
            if (umbrellaBoss.hp <= 0) { umbrellaBoss.isDying = true; umbrellaBoss.deathTimer = 60; }
        }
    }

    // Lógica Nuvem
    else if (cloudBoss.active) {
        if (cloudBoss.isDying) {
            cloudBoss.deathTimer--; cloudBoss.y -= 3;
            if (cloudBoss.deathTimer <= 0) gameState = 'WIN';
        } else {
            cloudBoss.attackTimer++;
            if (cloudBoss.hp < 125 && cloudBoss.phase === 1) { cloudBoss.phase = 2; document.getElementById('boss-lvl').innerText = "NUVEM FASE FINAL"; }
            cloudBoss.x += cloudBoss.vx; if (cloudBoss.x > 550 || cloudBoss.x < 50) cloudBoss.vx *= -1;
            
            if (cloudBoss.phase === 2) {
                if (cloudBoss.attackTimer % 150 === 100) cloudBoss.laserActive = 60;
                if (cloudBoss.laserActive > 0) {
                    cloudBoss.laserActive--;
                    if (cloudBoss.laserActive < 30) {
                        let laserRect = { x: cloudBoss.x + 80, y: cloudBoss.y + 50, w: 40, h: 400 };
                        if (checkRectCollision(player, laserRect) && player.invul <= 0) { player.hp--; player.invul = 60; updateHUD(); }
                    }
                }
            }
            if (cloudBoss.attackTimer % 30 === 0) bBullets.push({x: cloudBoss.x + 100, y: cloudBoss.y + 50, vx: 0, vy: 9, size: 15, color: '#f1c40f'});
            if (cloudBoss.hp <= 0) { cloudBoss.isDying = true; cloudBoss.deathTimer = 60; bBullets = []; }
        }
    }

    bBullets.forEach((b, i) => {
        b.x += (b.vx || 0); b.y += (b.vy || 0);
        if (checkRectCollision(b, player) && player.invul <= 0) { player.hp--; player.invul = 60; updateHUD(); bBullets.splice(i, 1); }
        if (b.x < -100 || b.x > 900 || b.y > canvas.height + 50) bBullets.splice(i, 1);
    });

    if (player.invul > 0) player.invul--;
    if (player.hp <= 0) gameState = 'GAMEOVER';
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Chão visível
    ctx.fillStyle = '#3e5a2a'; 
    ctx.fillRect(0, canvas.height - 40, canvas.width, 40);

    if (gameState !== 'PLAYING') {
        ctx.fillStyle = 'rgba(0,0,0,0.85)'; ctx.fillRect(0,0,800,450);
        ctx.fillStyle = 'white'; ctx.textAlign = 'center';
        if (gameState === 'MENU') { ctx.font = '40px Arial Black'; ctx.fillText('FLORAL FURY', 400, 200); ctx.font = '20px Arial'; ctx.fillText('ENTER PARA INICIAR', 400, 250); }
        if (gameState.includes('NEXT_BOSS')) { ctx.fillText('BOSS DERROTADO!', 400, 200); ctx.fillText('ENTER PARA O PRÓXIMO', 400, 250); }
        if (gameState === 'GAMEOVER') { ctx.fillStyle = 'red'; ctx.fillText('GAME OVER', 400, 200); ctx.fillStyle = 'white'; ctx.fillText('ENTER PARA VOLTAR AO CHEFE', 400, 260); }
        if (gameState === 'WIN') { ctx.fillStyle = 'gold'; ctx.fillText('VITÓRIA TOTAL!', 400, 200); }
    } 
    else {
        // Plataformas Sólidas e Visíveis
        ctx.fillStyle = '#8e44ad'; 
        platforms.forEach(p => ctx.fillRect(p.x, p.y, p.w, p.h));
        
        if (boss.active) {
            ctx.save();
            if(boss.isDying) ctx.globalAlpha = boss.deathTimer / 60;
            ctx.fillStyle = '#1b4d1b'; ctx.fillRect(boss.x + 80, 230, 30, 250);
            ctx.fillStyle = boss.phase === 3 ? '#8b0000' : '#ff8c00';
            for(let i = 0; i < 8; i++) { ctx.save(); ctx.translate(boss.x + 90, 150); ctx.rotate((i * Math.PI * 2) / 8 + boss.attackTimer * 0.02); ctx.beginPath(); ctx.ellipse(65, 0, 40, 25, 0, 0, Math.PI * 2); ctx.fill(); ctx.restore(); }
            ctx.fillStyle = '#f7e442'; ctx.beginPath(); ctx.arc(boss.x + 90, 150, 55, 0, Math.PI * 2); ctx.fill();
            ctx.restore();
        }
        
        if (umbrellaBoss.active) {
            ctx.save();
            ctx.translate(umbrellaBoss.x + umbrellaBoss.w/2, umbrellaBoss.y + 50);
            ctx.rotate(umbrellaBoss.rotation);
            ctx.fillStyle = '#2471a3'; ctx.beginPath(); ctx.arc(0, 0, 80, Math.PI, 0); ctx.fill();
            ctx.strokeStyle = 'white'; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(0, 80); ctx.stroke(); 
            ctx.restore();
        }

        if (cloudBoss.active) {
            ctx.save();
            if(cloudBoss.isDying) ctx.globalAlpha = cloudBoss.deathTimer / 60;
            ctx.fillStyle = cloudBoss.phase === 2 ? '#2c3e50' : '#bdc3c7';
            ctx.beginPath();
            ctx.arc(cloudBoss.x + 50, cloudBoss.y + 50, 40, 0, Math.PI * 2);
            ctx.arc(cloudBoss.x + 100, cloudBoss.y + 30, 60, 0, Math.PI * 2);
            ctx.arc(cloudBoss.x + 150, cloudBoss.y + 50, 40, 0, Math.PI * 2);
            ctx.fill();
            if (cloudBoss.laserActive > 0) {
                ctx.fillStyle = cloudBoss.laserActive >= 30 ? 'rgba(255,0,0,0.3)' : '#fff';
                ctx.fillRect(cloudBoss.x + 80, cloudBoss.y + 50, 40, 400);
            }
            ctx.restore();
        }

        ctx.fillStyle = player.invul % 4 > 1 ? 'transparent' : 'red';
        ctx.fillRect(player.x, player.y, player.w, player.h);
        ctx.fillStyle = '#00f2ff'; pBullets.forEach(b => ctx.fillRect(b.x, b.y, b.size, b.size));
        bBullets.forEach(b => { ctx.fillStyle = b.color; ctx.fillRect(b.x, b.y, b.size, b.size); });
    }
    requestAnimationFrame(() => { update(); draw(); });
}
draw();
</script>
</body>
</html>
