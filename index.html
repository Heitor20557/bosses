<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Floral Fury & Umbrella Evolution - Refined</title>
    <style>
        body { margin: 0; background: #111; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        canvas { background: linear-gradient(to bottom, #5c8cae, #2c3e50); border: 4px solid #333; box-shadow: 0 0 30px rgba(0,0,0,0.5); border-radius: 4px; }
        #hud { position: absolute; top: 20px; left: 20px; color: #fff; font-size: 20px; font-weight: bold; text-shadow: 2px 2px #000; pointer-events: none; }
        .hp-bar { color: #ff3e3e; }
    </style>
</head>
<body>

<div id="hud">
    HP: <span id="hp-val" class="hp-bar">3</span> | 
    <span id="boss-lvl" style="color: #f1c40f;">FLOR FASE 1</span>
</div>
<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = 800; canvas.height = 450;

// Configurações e Estado
let gameState = 'MENU';
const keys = {};
let shake = 0;

// Objetos Globais
let player, boss, umbrellaBoss, pBullets, bBullets, platforms;

window.addEventListener('keydown', e => { 
    keys[e.code] = true; 
    if (gameState === 'MENU' && e.code === 'Enter') restartGame();
    else if (gameState === 'NEXT_BOSS' && e.code === 'Enter') startSecondBoss();
    else if ((gameState === 'GAMEOVER' || gameState === 'WIN') && e.code === 'Enter') restartGame();
});
window.addEventListener('keyup', e => keys[e.code] = false);

function restartGame() {
    player = { 
        x: 100, y: 300, w: 35, h: 50, vx: 0, vy: 0, 
        speed: 5, jump: -15, grounded: false, hp: 3, 
        shootTimer: 0, invul: 0, dashTimer: 0, isDashing: false, flip: false 
    };
    
    boss = { 
        x: 550, y: 70, w: 180, h: 160, hp: 100, maxHp: 100,
        phase: 1, attackTimer: 0, active: true, isDying: false, 
        deathTimer: 0, hitTimer: 0 
    };
    
    umbrellaBoss = { 
        x: 400, y: -200, w: 160, h: 120, hp: 150, maxHp: 150,
        phase: 1, attackTimer: 0, active: false,
        vx: 3, vy: 2, isDying: false, deathTimer: 0, rotation: 0, hitTimer: 0
    };

    pBullets = []; bBullets = [];
    platforms = [
        {x: 80, y: 310, w: 100, h: 15}, 
        {x: 230, y: 230, w: 100, h: 15}, 
        {x: 380, y: 310, w: 100, h: 15}
    ];
    gameState = 'PLAYING';
    document.getElementById('boss-lvl').innerText = "FLOR FASE 1";
    updateHUD();
}

function startSecondBoss() {
    player.x = 100; player.y = 300; player.hp = 3;
    umbrellaBoss.active = true;
    umbrellaBoss.y = 50; 
    gameState = 'PLAYING';
    document.getElementById('boss-lvl').innerText = "UMBRELLA FASE 1";
    updateHUD();
}

function updateHUD() { document.getElementById('hp-val').innerText = player.hp; }

function checkRectCollision(a, b) {
    const bW = b.w || b.size || 10;
    const bH = b.h || b.size || 10;
    const aW = a.w || a.size || 10;
    const aH = a.h || a.size || 10;
    return a.x < b.x + bW && a.x + aW > b.x && a.y < b.y + bH && a.y + aH > b.y;
}

function update() {
    if (gameState !== 'PLAYING') return;

    if (shake > 0) shake--;

    // Movimentação Player
    if (keys['KeyC'] && player.dashTimer <= 0) { 
        player.isDashing = true; player.dashTimer = 35; player.invul = 15; 
    }
    
    if (player.isDashing) { 
        player.vx = 14; 
        if (player.dashTimer < 20) player.isDashing = false; 
    } else {
        if (keys['ArrowLeft']) { player.vx = -player.speed; player.flip = true; }
        else if (keys['ArrowRight']) { player.vx = player.speed; player.flip = false; }
        else player.vx = 0;
    }
    
    if (player.dashTimer > 0) player.dashTimer--;
    if ((keys['Space'] || keys['KeyZ']) && player.grounded) { 
        player.vy = player.jump; player.grounded = false; 
    }

    player.vy += 0.8; // Gravidade
    player.x += player.vx;
    player.y += player.vy;

    // Limites Chão e Plataformas
    if (player.y + player.h > canvas.height - 40) { 
        player.y = canvas.height - 40 - player.h; player.vy = 0; player.grounded = true; 
    }
    
    platforms.forEach(p => {
        if (player.vy > 0 && checkRectCollision(player, p) && player.y + player.h < p.y + 20) {
            player.y = p.y - player.h; player.vy = 0; player.grounded = true;
        }
    });

    // Tiros Player
    if (keys['KeyX'] && player.shootTimer <= 0) {
        pBullets.push({x: player.x + player.w, y: player.y + 15, size: 8});
        player.shootTimer = 8;
    }
    if (player.shootTimer > 0) player.shootTimer--;

    pBullets = pBullets.filter(b => {
        b.x += 12;
        let hit = false;
        if (boss.active && !boss.isDying && checkRectCollision(b, boss)) {
            boss.hp -= 1.5; boss.hitTimer = 5; hit = true;
        } else if (umbrellaBoss.active && !umbrellaBoss.isDying && checkRectCollision(b, umbrellaBoss)) {
            umbrellaBoss.hp -= 1.8; umbrellaBoss.hitTimer = 5; hit = true;
        }
        return !hit && b.x < canvas.width;
    });

    // LÓGICA BOSS 1
    if (boss.active) {
        if (boss.isDying) {
            boss.deathTimer--; boss.y += 5;
            if (boss.deathTimer <= 0) { boss.active = false; bBullets = []; gameState = 'NEXT_BOSS'; }
        } else {
            boss.attackTimer++;
            if (boss.hp < 66 && boss.phase === 1) { boss.phase = 2; document.getElementById('boss-lvl').innerText = "FLOR FASE 2"; }
            if (boss.hp < 33 && boss.phase === 2) { boss.phase = 3; document.getElementById('boss-lvl').innerText = "FLOR FASE FINAL"; }
            
            if (boss.phase === 1 && boss.attackTimer % 80 === 0) 
                bBullets.push({x: boss.x, y: 150, vx: -6, vy: 0, size: 20, color: '#e67e22'});
            else if (boss.phase === 2 && boss.attackTimer % 60 === 0) {
                let ang = Math.atan2(player.y - 150, player.x - boss.x);
                bBullets.push({x: boss.x, y: 150, vx: Math.cos(ang)*7, vy: Math.sin(ang)*7, size: 15, color: '#f1c40f'});
            } else if (boss.phase === 3 && boss.attackTimer % 40 === 0)
                bBullets.push({x: player.x, y: -20, vx: 0, vy: 8, size: 25, color: '#9b59b6'});

            if (boss.hp <= 0) { boss.isDying = true; boss.deathTimer = 60; }
        }
    } 

    // LÓGICA BOSS 2
    else if (umbrellaBoss.active) {
        if (umbrellaBoss.isDying) {
            umbrellaBoss.deathTimer--; umbrellaBoss.rotation += 0.3; umbrellaBoss.y -= 2;
            if (umbrellaBoss.deathTimer <= 0) gameState = 'WIN';
        } else {
            umbrellaBoss.attackTimer++;
            if (umbrellaBoss.phase === 1) {
                umbrellaBoss.x += umbrellaBoss.vx; umbrellaBoss.y = 50 + Math.sin(umbrellaBoss.attackTimer * 0.05) * 30;
                if (umbrellaBoss.x > 600 || umbrellaBoss.x < 50) umbrellaBoss.vx *= -1;
                if (umbrellaBoss.attackTimer % 50 === 0) bBullets.push({x: umbrellaBoss.x + 80, y: umbrellaBoss.y + 80, vx: 0, vy: 6, size: 14, color: '#3498db'});
            } else if (umbrellaBoss.phase === 2) {
                if (umbrellaBoss.attackTimer % 120 < 60) {
                    umbrellaBoss.x += (player.x - umbrellaBoss.x) * 0.05; 
                    umbrellaBoss.y += (30 - umbrellaBoss.y) * 0.1;
                } else {
                    umbrellaBoss.y += 15; if (umbrellaBoss.y > 450) umbrellaBoss.y = -100;
                }
                if (umbrellaBoss.attackTimer % 30 === 0) bBullets.push({x: umbrellaBoss.x+80, y: umbrellaBoss.y+50, vx: -6, vy: 2, size: 12, color: '#ecf0f1'});
            } else if (umbrellaBoss.phase === 3) {
                umbrellaBoss.x += (320 - umbrellaBoss.x) * 0.05; umbrellaBoss.y += (80 - umbrellaBoss.y) * 0.05;
                if (player.x < umbrellaBoss.x + 80) player.x += 0.5; else player.x -= 0.5;
                if (umbrellaBoss.attackTimer % 20 === 0) {
                    let ang = Math.random() * Math.PI * 2;
                    bBullets.push({x: umbrellaBoss.x + 80, y: umbrellaBoss.y + 50, vx: Math.cos(ang)*6, vy: Math.sin(ang)*6, size: 10, color: '#f1c40f'});
                }
            }
            if (umbrellaBoss.hp < 100 && umbrellaBoss.phase === 1) { umbrellaBoss.phase = 2; document.getElementById('boss-lvl').innerText = "UMBRELLA FASE 2"; }
            if (umbrellaBoss.hp < 50 && umbrellaBoss.phase === 2) { umbrellaBoss.phase = 3; document.getElementById('boss-lvl').innerText = "UMBRELLA FASE FINAL"; }
            if (umbrellaBoss.hp <= 0) { umbrellaBoss.isDying = true; umbrellaBoss.deathTimer = 60; bBullets = []; }
        }
    }

    // Balas Inimigas e Dano
    bBullets = bBullets.filter(b => {
        b.x += (b.vx || 0); b.y += (b.vy || 0);
        if (checkRectCollision(b, player) && player.invul <= 0) {
            takeDamage(); return false;
        }
        return b.x > -100 && b.x < 900 && b.y < 500;
    });

    if (player.invul > 0) player.invul--;
    if (boss.hitTimer > 0) boss.hitTimer--;
    if (umbrellaBoss.hitTimer > 0) umbrellaBoss.hitTimer--;
    if (player.hp <= 0) gameState = 'GAMEOVER';
}

function takeDamage() {
    player.hp--; player.invul = 60; shake = 10; updateHUD();
}

function draw() {
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (shake > 0) ctx.translate(Math.random()*shake - shake/2, Math.random()*shake - shake/2);

    // Chão
    ctx.fillStyle = '#2d5a27'; ctx.fillRect(0, canvas.height - 40, canvas.width, 40);

    if (gameState !== 'PLAYING') {
        ctx.fillStyle = 'rgba(0,0,0,0.85)'; ctx.fillRect(0,0,800,450);
        ctx.fillStyle = 'white'; ctx.textAlign = 'center';
        if (gameState === 'MENU') { 
            ctx.font = 'bold 45px Arial'; ctx.fillText('FLORAL FURY', 400, 200); 
            ctx.font = '20px Arial'; ctx.fillText('PRESSIONE ENTER PARA COMEÇAR', 400, 260); 
        }
        if (gameState === 'NEXT_BOSS') { 
            ctx.fillStyle = '#3498db'; ctx.font = 'bold 40px Arial'; ctx.fillText('BOSS 2: UMBRELLA', 400, 200); 
            ctx.fillStyle = 'white'; ctx.fillText('PRESSIONE ENTER PARA CONTINUAR', 400, 260); 
        }
        if (gameState === 'GAMEOVER') { 
            ctx.fillStyle = '#e74c3c'; ctx.font = 'bold 60px Arial'; ctx.fillText('GAME OVER', 400, 200); 
            ctx.fillStyle = 'white'; ctx.font = '20px Arial'; ctx.fillText('ENTER PARA RECOMEÇAR', 400, 280); 
        }
        if (gameState === 'WIN') { 
            ctx.fillStyle = '#f1c40f'; ctx.font = 'bold 60px Arial'; ctx.fillText('VITÓRIA!', 400, 200); 
            ctx.fillStyle = 'white'; ctx.fillText('VOCÊ DERROTOU A EVOLUÇÃO', 400, 260); 
        }
    } else {
        // Plataformas
        ctx.fillStyle = '#7d3c98';
        platforms.forEach(p => {
            ctx.fillRect(p.x, p.y, p.w, p.h);
            ctx.fillStyle = 'rgba(255,255,255,0.2)'; ctx.fillRect(p.x, p.y, p.w, 4); ctx.fillStyle = '#7d3c98';
        });
        
        // Desenho Flor
        if (boss.active) {
            ctx.save();
            if(boss.isDying) ctx.globalAlpha = boss.deathTimer / 60;
            if(boss.hitTimer > 0) ctx.filter = 'brightness(2)';
            
            // Caule
            ctx.fillStyle = '#1e8449'; ctx.fillRect(boss.x + 80, 230, 20, 250);
            // Pétalas
            ctx.fillStyle = boss.phase === 3 ? '#c0392b' : '#e67e22';
            for(let i=0; i<8; i++) {
                ctx.save(); ctx.translate(boss.x+90, 150); ctx.rotate(i * Math.PI/4 + Date.now()*0.002);
                ctx.beginPath(); ctx.ellipse(60, 0, 40, 20, 0, 0, Math.PI*2); ctx.fill(); ctx.restore();
            }
            // Miolo
            ctx.fillStyle = '#f4d03f'; ctx.beginPath(); ctx.arc(boss.x+90, 150, 50, 0, Math.PI*2); ctx.fill();
            // Olhos
            ctx.fillStyle = '#000'; ctx.fillRect(boss.x+70, 135, 8, 15); ctx.fillRect(boss.x+105, 135, 8, 15);
            ctx.restore();
        }
        
        // Desenho Umbrella
        if (umbrellaBoss.active) {
            ctx.save();
            ctx.translate(umbrellaBoss.x + 80, umbrellaBoss.y + 50);
            ctx.rotate(umbrellaBoss.rotation);
            if (umbrellaBoss.hitTimer > 0) ctx.filter = 'brightness(2)';
            
            // Topo da sombrinha
            ctx.fillStyle = umbrellaBoss.phase === 3 ? '#4a235a' : '#2980b9';
            ctx.beginPath(); ctx.arc(0, 0, 80, Math.PI, 0); ctx.fill();
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 4; ctx.stroke();
            // Cabo
            ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(0, 80); ctx.stroke();
            // Olhos
            ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(-20, -20, 10, 0, Math.PI*2); ctx.arc(20, -20, 10, 0, Math.PI*2); ctx.fill();
            ctx.restore();
        }

        // Player
        if (!(player.invul % 6 > 3)) {
            ctx.fillStyle = player.isDashing ? '#fff' : '#e74c3c';
            ctx.fillRect(player.x, player.y, player.w, player.h);
            // Olho do player para indicar direção
            ctx.fillStyle = 'black';
            let eyeX = player.flip ? player.x + 5 : player.x + player.w - 10;
            ctx.fillRect(eyeX, player.y + 10, 5, 10);
        }

        // Tiros
        ctx.fillStyle = '#5dade2'; pBullets.forEach(b => ctx.fillRect(b.x, b.y, b.size, b.size));
        bBullets.forEach(b => { ctx.fillStyle = b.color; ctx.fillRect(b.x, b.y, b.size, b.size); });
    }
    
    requestAnimationFrame(loop);
}

function loop() {
    update();
    draw();
}

loop();
</script>
</body>
</html>
